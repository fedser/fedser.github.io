<!DOCTYPE html>
<html lang="ru" xml:lang="ru" xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <title>Выберите адрес доставки или самовывоза</title>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <script
      src="https://api-maps.yandex.ru/2.1/?apikey=101e35d8-b016-4ee0-b2ba-cd5db91e77b3&lang=ru_RU"
      type="text/javascript"
    ></script>

    <script type="text/javascript">
      var showDepartmentsMode = false;
      var selectedDepartmentId = null;
      var myPlacemark, centerPinItem, objectManager, myMap;
      var departmentsAlreadyAdded = false;
      var wasUserInteraction = false;

      ymaps.ready(startInit);

      function startInit() {
        // console.log(`coord: ${department.lat}, ${department.lon}`);
        ymaps.geolocation
          .get({
            provider: "yandex",
            mapStateAutoApply: true,
            autoReverseGeocode: false,
          })
          .then(
            function (res) {
              // var mapContainer = $("#map"),
              //   bounds = res.geoObjects.get(0).properties.get("boundedBy"),
              //   // Рассчитываем видимую область для текущей положения пользователя.
              //   mapState = ymaps.util.bounds.getCenterAndZoom(bounds, [
              //     mapContainer.width(),
              //     mapContainer.height(),
              //   ]);
              // createMap(mapState);

              var coords = res.geoObjects.get(0).geometry.getCoordinates();
              createMap({
                center: coords,
                zoom: 17,
                controls: ["zoomControl"],
              });

              setMyLocationInternal(coords, false);
              emitCoordChanges("ip", coords);
            },
            function (e) {
              // Если местоположение невозможно получить, то просто создаем карту.
              createMap({
                center: [56.79861999, 53.193641],
                zoom: 17,
                controls: ["zoomControl"],
              });
            }
          );
      }

      function tryGetLocationInternal() {
        ymaps.geolocation
          .get({
            provider: "browser",
            mapStateAutoApply: true,
            autoReverseGeocode: false,
          })
          .then(
            function (res) {
              setMyLocationInternal(coords, false);
              emitCoordChanges("ip", coords);
            },
            function (e) {
              //do nothing
            }
          );
      }

      function createMap(state) {
        // myMap = new ymaps.Map("map", {
        //   center: [56.79861999, 53.193641],
        //   zoom: 7,
        //   controls: ["zoomControl"],
        // });

        myMap = new ymaps.Map("map", state);
        // var zoomControl = new ymaps.control.ZoomControl({
        //   options: {
        //     size: "small",
        //   },
        // });

        emitMapCenterChanged(myMap.getCenter());
        myMap.events.add("boundschange", function (e) {
          if (e.get("newCenter") != e.get("oldCenter")) {
            var coords = e.get("newCenter");
            emitMapCenterChanged(coords);
          }
        });

        myMap.events.add("mousedown", function (e) {
          if (!wasUserInteraction) {
            wasUserInteraction = true;
            mapUserInteraction();
          }
        });
        myMap.events.add("multitouchstart", function (e) {
          if (!wasUserInteraction) {
            wasUserInteraction = true;
            mapUserInteraction();
          }
        });
        myMap.events.add("wheel", function (e) {
          if (!wasUserInteraction) {
            wasUserInteraction = true;
            mapUserInteraction();
          }
        });

        objectManager = new ymaps.ObjectManager({
          // Чтобы метки начали кластеризоваться, выставляем опцию.
          clusterize: true,
          // ObjectManager принимает те же опции, что и кластеризатор.
          gridSize: 32,
          // clusterDisableClickZoom: true,
          clusterHasBalloon: false,
          geoObjectOpenBalloonOnClick: false,
        });
        objectManager.clusters.options.set(
          "preset",
          "islands#darkgreenClusterIcons"
        );
        objectManager.setFilter(function (object) {
          return showDepartmentsMode;
        });
        objectManager.objects.events.add("click", function (e) {
          var departmentId = e.get("objectId");
          var objectState = objectManager.getObjectState(departmentId);
          if (objectState.found && objectState.isShown) {
            // Если объект попадает в кластер
            if (objectState.isClustered) {
              // objectManager.clusters.state.set("activeObject", objects[1]);
              // objectManager.clusters.balloon.open(objectState.cluster.id);
            } else {
              // Если объект не попал в кластер, открываем его собственный балун.
              // objectManager.objects.balloon.open(objects[i].id);
              selectDepartmentWithId(departmentId);
            }
          }

          departmentClicked(departmentId);
        });

        // var createdPlacemark = new ymaps.Placemark(
        //   coords,
        //   {},
        //   {
        //     draggable: false,
        //     iconLayout: "default#image",
        //     iconImageHref: "/shop14/assets/assets/map_center_pin.png",
        //     iconImageSize: [40, 40],
        //     iconImageOffset: [-20, -40],
        //     zIndex: 2,
        //   }
        // );

        centerPinItem = document.getElementById("center-pin");
        updateCenterPinVisibility();

        mapDidInit("");
      }

      function emitMapCenterChanged(coords) {
        if (coords.length >= 2) {
          // MyCoordChanged(coords[0], coords[1]);
          var obj = new Object();
          obj.lat = coords[0];
          obj.lon = coords[1];
          var jsonString = JSON.stringify(obj);
          mapCenterChanged(jsonString);
        }
      }

      function emitCoordChanges(action, coords) {
        if (coords.length >= 2) {
          var obj = new Object();
          obj.action = action;
          obj.lat = coords[0];
          obj.lon = coords[1];
          var jsonString = JSON.stringify(obj);
          myPositionChanged(jsonString);
        }
      }

      function tryGetMyLocation() {
        var geolocation = ymaps.geolocation;

        // Сравним положение, вычисленное по ip пользователя и
        // положение, вычисленное средствами браузера.
        geolocation
          .get({
            provider: "yandex",
            mapStateAutoApply: true,
            autoReverseGeocode: false,
          })
          .then(function (result) {
            // Красным цветом пометим положение, вычисленное через ip.
            // Получение местоположения пользователя.
            var coords = result.geoObjects.get(0).geometry.getCoordinates();
            setMyLocationInternal(coords, true);
            emitCoordChanges("ip", coords);
          });

        geolocation
          .get({
            provider: "browser",
            mapStateAutoApply: true,
            autoReverseGeocode: false,
          })
          .then(function (result) {
            // Синим цветом пометим положение, полученное через браузер.
            // Если браузер не поддерживает эту функциональность, метка не будет добавлена на карту.

            var coords = result.geoObjects.get(0).geometry.getCoordinates();
            setMyLocationInternal(coords, true);
            emitCoordChanges("browser", coords);
          });
      }

      function setShowDepartmentsMode(enable) {
        if (showDepartmentsMode != enable) {
          showDepartmentsMode = enable;
          updateCenterPinVisibility();
          objectManager.setFilter(function (object) {
            return showDepartmentsMode;
          });
          //TODO: if (showDepartmentsMode == true) then zoom on departments area
        }
      }

      function updateCenterPinVisibility() {
        centerPinItem.style.display = showDepartmentsMode ? "none" : "block";
      }

      function selectDepartmentWithId(departmentId) {
        if (departmentId != selectedDepartmentId) {
          if (selectedDepartmentId != null) {
            objectManager.objects.setObjectOptions(selectedDepartmentId, {
              iconLayout: "default#image",
              iconImageHref: "/shop14/assets/assets/map_department.png",
              iconImageSize: [32, 32],
              iconImageOffset: [-16, -16],
            });
          }
          if (departmentId != null) {
            objectManager.objects.setObjectOptions(departmentId, {
              iconLayout: "default#image",
              iconImageHref: "/shop14/assets/assets/map_department_selected.png",
              iconImageSize: [42, 42],
              iconImageOffset: [-21, -21],
            });
            var departmentObject = objectManager.objects.getById(departmentId);
            if (departmentObject != null) {
              myMap.setCenter(
                departmentObject.geometry.coordinates,
                myMap.zoom,
                {
                  checkZoomRange: true,
                  duration: 500,
                }
              );
              setShowDepartmentsMode(true);
            }
          }
          selectedDepartmentId = departmentId;
        }
      }

      function setDepartments(params) {
        if (departmentsAlreadyAdded) {
          return;
        }
        const data = JSON.parse(params);
        var departments = data.deps;
        var objects = [];
        for (let index = 0; index < departments.length; index++) {
          const department = departments[index];
          objects.push({
            type: "Feature",
            id: department.id,
            geometry: {
              type: "Point",
              coordinates: [department.lat, department.lon],
            },
            options: {
              iconLayout: "default#image",
              iconImageHref: "/shop14/assets/assets/map_department.png",
              iconImageSize: [32, 32],
              iconImageOffset: [-16, -16],
            },
          });
        }
        objectManager.add(objects);
        myMap.geoObjects.add(objectManager);

        departmentsAlreadyAdded = true;
        objectManager.setFilter(function (object) {
          return showDepartmentsMode;
        });
        //TODO: if (showDepartmentsMode == true) then zoom on departments area
      }

      function createPlacemark(coords) {
        var createdPlacemark = new ymaps.Placemark(
          coords,
          {},
          {
            draggable: true,
            iconLayout: "default#image",
            iconImageHref: "/shop14/assets/assets/map_my_position.png",
            iconImageSize: [44, 44],
            iconImageOffset: [-22, -22],
          }
        );
        return createdPlacemark;
      }

      function setMapCenter(params) {
        const data = JSON.parse(params);

        myMap.setCenter([data.lat, data.lon], 17, {
          checkZoomRange: true,
          duration: 1000,
        });
      }

      function setMyLocationInternal(coords, needCenter) {
        if (myPlacemark) {
          myPlacemark.geometry.setCoordinates(coords);
        } else {
          myPlacemark = createPlacemark(coords);
          myMap.geoObjects.add(myPlacemark);
        }
        if (needCenter) {
          myMap.setCenter(coords, 17, {
            checkZoomRange: true,
            duration: 1000,
          });
        }
      }

      function setMyLocation(params) {
        const data = JSON.parse(params);
        var coords = [data.lat, data.lon];
        setMyLocationInternal(coords, data.needCenter);
      }
    </script>
    <style>
      html,
      body,
      #map {
        width: 100%;
        height: 100%;
        padding: 0;
        margin: 0;
      }

      #center-pin {
        display: block;
        position: absolute;
        z-index: 2;
        width: 40px;
        height: 40px;
        text-align: center;
        left: 50%;
        top: 50%;
        margin-left: -20px;
        margin-top: -40px;
      }
    </style>
  </head>

  <body>
    <div id="map">
      <img id="center-pin" src="/shop14/assets/assets/map_center_pin.png" />
    </div>
  </body>
</html>
