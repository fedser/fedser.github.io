<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <title>Выберите адрес доставки или самовывоза</title>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <script
      src="https://api-maps.yandex.ru/2.1/?apikey=101e35d8-b016-4ee0-b2ba-cd5db91e77b3&lang=ru_RU"
      type="text/javascript"
    ></script>

    <script type="text/javascript">
      var showDepartmentsMode = false;
      var selectedDepartmentId = null;
      var myPlacemark, centerPinItem, objectManager, myMap;
      var departmentsAlreadyAdded = false;

      ymaps.ready(init);

      function init() {
        myMap = new ymaps.Map("map", {
          center: [55.76, 37.64],
          zoom: 7,
          controls: ["zoomControl"],
        });
        emitMapCenterChanged(myMap.getCenter());
        myMap.events.add("boundschange", function (e) {
          if (e.get("newCenter") != e.get("oldCenter")) {
            var coords = e.get("newCenter");
            emitMapCenterChanged(coords);
          }
        });
        objectManager = new ymaps.ObjectManager({
          // Чтобы метки начали кластеризоваться, выставляем опцию.
          clusterize: true,
          // ObjectManager принимает те же опции, что и кластеризатор.
          gridSize: 32,
          // clusterDisableClickZoom: true,
          clusterHasBalloon: false,
          geoObjectOpenBalloonOnClick: false,
        });
        objectManager.clusters.options.set(
          "preset",
          "islands#darkgreenClusterIcons"
        );
        objectManager.setFilter(function (object) {
          return showDepartmentsMode;
        });
        objectManager.objects.events.add("click", function (e) {
          var departmentId = e.get("objectId");
          var objectState = objectManager.getObjectState(departmentId);
          if (objectState.found && objectState.isShown) {
            // Если объект попадает в кластер
            if (objectState.isClustered) {
              // objectManager.clusters.state.set("activeObject", objects[1]);
              // objectManager.clusters.balloon.open(objectState.cluster.id);
            } else {
              // Если объект не попал в кластер, открываем его собственный балун.
              // objectManager.objects.balloon.open(objects[i].id);
              selectDepartmentWithId(departmentId);
            }
          }

          departmentClicked(departmentId);
        });

        // var createdPlacemark = new ymaps.Placemark(
        //   coords,
        //   {},
        //   {
        //     draggable: false,
        //     iconLayout: "default#image",
        //     iconImageHref: "/shop8/assets/assets/map_center_pin.png",
        //     iconImageSize: [40, 40],
        //     iconImageOffset: [-20, -40],
        //     zIndex: 2,
        //   }
        // );
        centerPinItem = document.getElementById("center-pin");
        updateCenterPinVisibility();

        mapDidInit("");
      }

      function emitMapCenterChanged(coords) {
        if (coords.length >= 2) {
          // MyCoordChanged(coords[0], coords[1]);
          var obj = new Object();
          obj.lat = coords[0];
          obj.lon = coords[1];
          var jsonString = JSON.stringify(obj);
          mapCenterChanged(jsonString);
        }
      }

      function setShowDepartmentsMode(enable) {
        if (showDepartmentsMode != enable) {
          showDepartmentsMode = enable;
          updateCenterPinVisibility();
          objectManager.setFilter(function (object) {
            return showDepartmentsMode;
          });
          //TODO: if (showDepartmentsMode == true) then zoom on departments area
        }
      }

      function updateCenterPinVisibility() {
        centerPinItem.style.display = showDepartmentsMode ? "none" : "block";
      }

      function selectDepartmentWithId(departmentId) {
        if (departmentId != selectedDepartmentId) {
          if (selectedDepartmentId != null) {
            objectManager.objects.setObjectOptions(selectedDepartmentId, {
              iconLayout: "default#image",
              iconImageHref: "/shop8/assets/assets/map_department.png",
              iconImageSize: [32, 32],
              iconImageOffset: [-16, -16],
            });
          }
          if (departmentId != null) {
            objectManager.objects.setObjectOptions(departmentId, {
              iconLayout: "default#image",
              iconImageHref: "/shop8/assets/assets/map_department_selected.png",
              iconImageSize: [42, 42],
              iconImageOffset: [-21, -21],
            });
            var departmentObject = objectManager.objects.getById(departmentId);
            if (departmentObject != null) {
              myMap.setCenter(
                departmentObject.geometry.coordinates,
                myMap.zoom,
                {
                  checkZoomRange: true,
                  duration: 500,
                }
              );
              setShowDepartmentsMode(true);
            }
          }
          selectedDepartmentId = departmentId;
        }
      }

      function setDepartments(params) {
        if (departmentsAlreadyAdded) {
          return;
        }
        const data = JSON.parse(params);
        var departments = data.deps;
        var objects = [];
        for (let index = 0; index < departments.length; index++) {
          const department = departments[index];
          objects.push({
            type: "Feature",
            id: department.id,
            geometry: {
              type: "Point",
              coordinates: [department.lat, department.lon],
            },
            options: {
              iconLayout: "default#image",
              iconImageHref: "/shop8/assets/assets/map_department.png",
              iconImageSize: [32, 32],
              iconImageOffset: [-16, -16],
            },
          });
        }
        objectManager.add(objects);
        myMap.geoObjects.add(objectManager);

        departmentsAlreadyAdded = true;
        objectManager.setFilter(function (object) {
          return showDepartmentsMode;
        });
        //TODO: if (showDepartmentsMode == true) then zoom on departments area
      }

      function createPlacemark(coords) {
        var createdPlacemark = new ymaps.Placemark(
          coords,
          {},
          {
            draggable: true,
            iconLayout: "default#image",
            iconImageHref: "/shop8/assets/assets/map_my_position.png",
            iconImageSize: [44, 44],
            iconImageOffset: [-22, -22],
          }
        );
        //
        createdPlacemark.events.add("dragend", function () {
          emitCoordChanges(
            "dragend",
            createdPlacemark.geometry.getCoordinates()
          );
        });
        return createdPlacemark;
      }

      function setMapCenter(params) {
        const data = JSON.parse(params);

        myMap.setCenter([data.lat, data.lon], 17, {
          checkZoomRange: true,
          duration: 1000,
        });
      }

      function setMyLocation(params) {
        const data = JSON.parse(params);

        var coords = [data.lat, data.lon];
        if (myPlacemark) {
          myPlacemark.geometry.setCoordinates(coords);
        } else {
          myPlacemark = createPlacemark(coords);
          myMap.geoObjects.add(myPlacemark);
        }
        if (data.needCenter) {
          myMap.setCenter(coords, 17, {
            checkZoomRange: true,
            duration: 1000,
          });
        }

        // markerElement.css({
        //   left: "50%",
        //   top: "50%",
        //   // left: markerPosition[0],
        //   // top: markerPosition[1]
        // });
      }
    </script>
    <style>
      html,
      body,
      #map {
        width: 100%;
        height: 100%;
        padding: 0;
        margin: 0;
      }

      #center-pin {
        display: block;
        position: absolute;
        z-index: 2;
        width: 40px;
        height: 40px;
        text-align: center;
        left: 50%;
        top: 50%;
        margin-left: -20px;
        margin-top: -40px;
      }
    </style>
  </head>

  <body>
    <div id="map">
      <img id="center-pin" src="/shop8/assets/assets/map_center_pin.png" />
    </div>
  </body>
</html>
