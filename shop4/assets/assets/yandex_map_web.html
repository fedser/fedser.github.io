<!DOCTYPE html>
<html>
  <head>
    <title>Определение местоположения пользователя</title>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <!--
        Укажите свой API-ключ. Тестовый ключ НЕ БУДЕТ работать на других сайтах.
        Получить ключ можно в Кабинете разработчика: https://developer.tech.yandex.ru/keys/
    -->
    <script
      src="https://api-maps.yandex.ru/2.1/?lang=ru_RU&amp;apikey=101e35d8-b016-4ee0-b2ba-cd5db91e77b3"
      type="text/javascript"
    ></script>
    <script>
      var myPlacemark, myMap, departmentsCollection;

      ymaps.ready(init);

      function setMapCenter(params) {
        const data = JSON.parse(params);
        myMap.setCenter([data.lat, data.lon], 17, {
          checkZoomRange: true,
          duration: 1000,
        });
      }

      function setDepartments(params) {
        console.log("Hi from JS2 +++");
        console.log(typeof params);
        // console.log("count: ", params.length);
        console.log(params);
        // const listJsonTexts = JSON.parse("'" + params+ "'" );
        // const data = JSON.parse('{"deps":[{"lat":55.73,"lng":37.75},{"lat":55.81,"lng":37.75}]}');
        const data = JSON.parse(params);
        // console.log(typeof data.deps);
        // console.log("count: ", listJsonTexts.length);
        // console.log(data.deps);
        var departments = data.deps;
        console.log(`departments.length: ${departments.length}`);
        // console.log(listJsonTexts);

        if (departmentsCollection.getLength() > 0) {
          myMap.geoObjects.remove(departmentsCollection);
          departmentsCollection.removeAll();
        }

        console.log(` step 1`);
        // deparmentsCollection = new ymaps.GeoObjectCollection(null, {
        //   preset: "islands#darkGreenCircleDotIcon",
        // });
        console.log(` step 2`);

        for (let index = 0; index < departments.length; index++) {
          const department = departments[index];
          console.log(`coord: ${department.lat}, ${department.lon}`);
          const placemark = new ymaps.Placemark([
            department.lat,
            department.lon,
          ]);
          placemark.events.add("click", function () {
            departmentClicked(department.id);
          });
          departmentsCollection.add(placemark);
        }
        console.log(
          `departmentsCollection.length: ${departmentsCollection.getLength()}`
        );
        // console.log(
        //   `deparmentsCollection.length: ${deparmentsCollection.length}`
        // );
        console.log(` step 3`);

        //     for (var i = 0, l = blueCoords.length; i < l; i++) {
        //     blueCollection.add(new ymaps.Placemark(blueCoords[i]));
        // }
        // // // departmentsCollection.add(new ymaps.Placemark([55.73, 37.65]));
        if (departmentsCollection.getLength() > 0) {
          myMap.geoObjects.add(departmentsCollection);
        }

        console.log("Hi from JS2 ---");
      }

      function init() {
        mapDidInit("");
        var geolocation = ymaps.geolocation;
        myMap = new ymaps.Map(
          "map",
          {
            center: [55.753994, 37.622093],
            zoom: 9,
            // controls: ['zoomControl']
          },
          {
            searchControlProvider: "yandex#search",
          }
        );

        departmentsCollection = new ymaps.GeoObjectCollection(null, {
          preset: "islands#blueIcon",
        });

        function emitCoordChanges(action, coords) {
          if (coords.length >= 2) {
            // MyCoordChanged(coords[0], coords[1]);
            var obj = new Object();
            obj.action = action;
            obj.lat = coords[0];
            obj.lon = coords[1];
            var jsonString = JSON.stringify(obj);
            myPositionChanged(jsonString);
          }
        }
        function createPlacemark(coords) {
          var createdPlacemark = new ymaps.Placemark(
            coords,
            {
              iconCaption: "",
            },
            {
              preset: "islands#darkGreenDotIcon",
              draggable: true,
            }
          );
          createdPlacemark.events.add("dragend", function () {
            emitCoordChanges(
              "dragend",
              createdPlacemark.geometry.getCoordinates()
            );
          });
          return createdPlacemark;
        }

        // function updatePlacemarkCoords(coords) {
        //     return new ymaps.Placemark(coords, {
        //         preset: 'islands#darkGreenDotIcon',
        //         draggable: true
        //     });
        // }

        // myMap = new ymaps.Map('map', {
        //     center: [55, 34],
        //     zoom: 10
        // }, {
        //     searchControlProvider: 'yandex#search'
        // });
        // myMap.behaviors.disable('scrollZoom');
        myMap.cursors.push("arrow");

        myMap.events.add("click", function (e) {
          var coords = e.get("coords");
          if (myPlacemark) {
            myPlacemark.geometry.setCoordinates(coords);
          } else {
            myPlacemark = createPlacemark(coords);
            myMap.geoObjects.add(myPlacemark);
          }
          emitCoordChanges("click", coords);
        });

        // Сравним положение, вычисленное по ip пользователя и
        // положение, вычисленное средствами браузера.
        geolocation
          .get({
            provider: "yandex",
            mapStateAutoApply: true,
            autoReverseGeocode: false,
          })
          .then(function (result) {
            // Красным цветом пометим положение, вычисленное через ip.
            result.geoObjects.options.set("preset", "islands#redCircleIcon");
            // Получение местоположения пользователя.
            // var userAddress = result.geoObjects.get(0).properties.get('text');
            var coords = result.geoObjects.get(0).geometry.getCoordinates();

            // Пропишем полученный адрес в балуне.
            // result.geoObjects.get(0).properties.set({
            //     balloonContentBody: 'Адрес: ' + userAddress +
            //                         '<br/>Координаты:' + userCoodinates
            // });

            // result.geoObjects.get(0).properties.set({
            //     balloonContentBody: 'Мое местоположение_11'
            // });
            // myMap.geoObjects.add(result.geoObjects);
            if (myPlacemark) {
              myPlacemark.geometry.setCoordinates(coords);
            } else {
              myPlacemark = createPlacemark(coords);
              myMap.geoObjects.add(myPlacemark);
            }
            emitCoordChanges("ip", coords);
            myMap.setCenter(coords, 17, {
              checkZoomRange: true,
              duration: 1000,
            });
          });

        geolocation
          .get({
            provider: "browser",
            mapStateAutoApply: true,
            autoReverseGeocode: false,
          })
          .then(function (result) {
            // Синим цветом пометим положение, полученное через браузер.
            // Если браузер не поддерживает эту функциональность, метка не будет добавлена на карту.
            result.geoObjects.options.set("preset", "islands#blueCircleIcon");
            // result.geoObjects.get(0).properties.set({
            //     balloonContentBody: 'Мое местоположение_22'
            // });
            var coords = result.geoObjects.get(0).geometry.getCoordinates();
            if (myPlacemark) {
              myPlacemark.geometry.setCoordinates(coords);
            } else {
              myPlacemark = createPlacemark(coords);
              myMap.geoObjects.add(myPlacemark);
            }
            emitCoordChanges("browser", coords);
            myMap.setCenter(coords, 17, {
              checkZoomRange: true,
              duration: 1000,
            });
            // myMap.panTo(coords, {
            //     // Задержка между перемещениями.
            //     delay: 1500
            // });
          });
      }
    </script>
    <style>
      html,
      body,
      #map {
        width: 100%;
        height: 100%;
        padding: 0;
        margin: 0;
      }
    </style>
  </head>

  <body>
    <div id="map"></div>
  </body>
</html>
